language: ruby
rvm:
- 2.2
sudo: required

before_install:
- openssl aes-256-cbc -K $encrypted_0c41919e9cd0_key -iv $encrypted_0c41919e9cd0_iv
  -in deploy-key.enc -out deploy-key -d
- eval `ssh-agent -s`
- chmod 600 deploy-key && ssh-add deploy-key && rm deploy-key
- bash _scripts/ssh_autenticity.sh #add servers to known hosts
- sudo cp _scripts/slack_message.sh /usr/local/bin/ && sudo chmod +x /usr/local/bin/slack_message.sh #install slack notifier script
- sudo add-apt-repository -y ppa:nginx/development 
- sudo apt-get update
- sudo apt-get -qq -y install nginx 

script:
- sh -c "cd Websites/website && bundle exec jekyll build" #build first site withouth dir change
- bash _scripts/tests/html/htmlproofer.sh

after_success:
#If it's the master branch, also deploy config
- test $TRAVIS_PULL_REQUEST == "false" && test $TRAVIS_BRANCH == "master" && bash _scripts/deploy_config.sh
- slack_message.sh -t "Deployed" -b "$(cat slack_message.txt)" -c "repositories" -u "$SLACK_WEBHOOK_URL"

addons:
  sauce_connect:
    username: "fermiumlabs"
    access_key:
      secure: "TJtgwF0unsFgh9WoSCQD7e2206VSPxfKb11k9r9irEWIC0PV0/NzFeHBDpf5rVTpqzFP4gaKl/iXdh9U89Q4DQ4zwJDrM4JgIRmTX4e0MQUkK9EQJVTc7WpHiKP1n/HOFORy0O/oab79/AOtsVFfB9jQZeMQ6Aks5goYq8ZnytESYNi6rjVHTXViZNxOPkPxZqQ1qWi/s/6lW9x2av0XdIgnmfUemJ9LmADE8uBcUOplU56Rn0kwSSF2AObSdQZ1iAY0uBlRdqHImjLTHuTqvrN7ShS2M0MYj7MZEEwH6RJUv4DhAulxZbeufkZ4MWvnO/75cmuVIGJEwANOJ2+tB/ZoHYGx9Xe0xqb6O0p8gIGjeDz61KiQvr8VBEppr0oCYzEBfaYYcVzMbH9YBE9vQBy+ZA8AhYwjIEy6nKVStn5Q2nFbg+Ux1Uag65QbNNzssoAoeO/Gn2bhDLeNEgu6/id3qeJOCPdCb+wnk6tpm/DnWys3fS9a5CPdE2jmeedSt0ewmT9/NcmyyrdmjLtgfmBVkGTgO7JRIr0ewH+2TX6RaldrCENjb5ZHExUGkdO1trR2ZDStUcqf52Luf1/Vh2+tc6URc9bXADyA/OFOBM0rqjTI0hutFV9crFSW5aHyMkpqxmFJMKBiETjW4iolBBTEIvD/3QkiLpELKaDVrto="

deploy:
  provider: script
  script: _scripts/deploy.sh
  skip_cleanup: true

#Only the master and develop branches destinations git configured in the server
branches:
  only:
  - master
  - develop

notifications:
  slack:
    on_success: always
    on_start: always
    rooms:
      secure: R35J/HeR/8Gj1xz/6leLx6yaKn6FujyfItoYKb6olpIthEayKexy1OSahjUOy0Euq7QmTrdOLM2ZlRjAUTg11ea75oO47U1bV58gQtz1UPhBJHAMO3B2Puuop2f7AmaAw5IEwRrUVtDD+ihS+oErbJR+JJK8FcpmWNTOfr77Ei/xjqgs9EZnwgDdS7RMowsfKxyDdIq1uU6FT4VckSBbfAknuVdK1tmF6H5RsitA74EMeuQ+nor+SlWZSt3G2aRwowv5hcXm9t6Oq+8pa2dVweYPt+p833gFh0hh2oqHo5KQYUfXiOrt2pSkjW83mhip458XnvrjlxlHIYZKdff3334Rv2Rl0Jjqxugn+foYnLTuB+z93BY401tC6TooVUbqXkbW8TAu89xeHNOhltm0XVXWsTNvciIStZ+C94UZSRV0XksBvWDFCmIJqnQPSOBFiccOU7X0UUpCuNRF5R3OHj3wkPgWsYlUOixUtPq9HxX0VayXKobZgJ4me7ayIaqax4uV5tAqBVRA0tS3lnkWWwkFSpdLqKXdplR+efenN27/XRYplsa3j0YkHsoNPLLHiSj5KIlZioh/pNRigJ1uZQ7LqlwKv1dhB69L0Ws3+7lKOoqnnqfJhUmZVu/wMZOv9cmS9BVfYjNZn+5njjSBwpdl4Iqsxh2qr3XjCaUyoVE=
  email: false
  
env:
  global:
  - NOKOGIRI_USE_SYSTEM_LIBRARIES=true #make html-proofer build faster
